+++
title = "戦闘"
date = 2022-07-11
+++

## 要約

戦闘結果は以下の要素に依存する(ランダム要素なし):

* 戦闘参加する味方/敵の艦隊数
* 戦闘参加する味方/敵の総兵力
* 戦闘参加する味方各艦隊の疲労度
* 味方/敵のフォーメーション
* 敵にヤンが参加しているかどうか

処理の大まかな流れは以下の通り:

* 味方/敵それぞれについて、攻撃可能な総兵力と彼我のフォーメーションにより攻撃力を求める。
* 敵にヤンが参加している場合、味方/敵それぞれの攻撃力に補正をかける。ただし味方フォーメーションが 5 ならば補正なし。
* 味方/敵それぞれについて 1 個艦隊あたりのダメージを求める。
* 味方/敵の各艦隊について求めたダメージを加算する。ダメージが閾値以上になった艦隊は壊滅させる。


## 詳細

ここで「兵力」の単位は 1 個艦隊に対する % とする。たとえば、無傷の 1 個艦隊は兵力 100, それぞれダメージ 20 を受けた 2 個艦隊は兵力 160, など。

### 艦隊数

味方/敵とも、戦場にいる全艦隊が自動的に戦闘参加する。  
また、敵の場合、駐留艦隊の兵力が残っていればこれも 1 個艦隊としてカウントされる。

### 攻撃力(ヤン補正前)

ヤン補正前の攻撃力は、味方/敵とも `(攻撃可能な総兵力) / 100 * (フォーメーション係数)` で算出される。

攻撃可能な総兵力は以下のように算出される:

* 味方の場合、戦闘参加する全艦隊のうち疲労度 80 未満の艦隊の兵力の総和をとる。  
  敵の場合は単に戦闘参加する全艦隊の兵力の総和をとる(疲労度は考慮されない)。
* 求めた値を `100..=1600` で clamp する(つまり、最低でも 1 個艦隊分は保証される)。

フォーメーション係数は以下のように算出される:

* 攻撃可能な総兵力(飽和前)を求める。これは、上記手順において下限 100 での飽和処理を省いた値を指す。
* 自陣営/相手陣営それぞれについて、`(攻撃可能な総兵力(飽和前)) / (10 * (艦隊数))` が 3 以下(つまり、攻撃可能な総兵力が最大兵力の 4 割未満)ならば、フォーメーションを 0 に修正する。  
* 自陣営/相手陣営のフォーメーションの組み合わせにより係数を得る。値は下表の通り。  
  (表は横に見ること。たとえば自陣営フォーメーションが 3, 相手陣営フォーメーションが 7 ならば係数は 5)

<table>
  <tr><th></th><th>0</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th></tr>
  <tr><th>0</th><td>3</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td><td>1</td></tr>
  <tr><th>1</th><td>5</td><td>4</td><td>3</td><td>5</td><td>4</td><td>2</td><td>2</td><td>4</td></tr>
  <tr><th>2</th><td>5</td><td>3</td><td>2</td><td>3</td><td>4</td><td>2</td><td>1</td><td>3</td></tr>
  <tr><th>3</th><td>5</td><td>3</td><td>3</td><td>4</td><td>4</td><td>4</td><td>3</td><td>5</td></tr>
  <tr><th>4</th><td>5</td><td>4</td><td>2</td><td>4</td><td>5</td><td>4</td><td>5</td><td>5</td></tr>
  <tr><th>5</th><td>5</td><td>4</td><td>3</td><td>3</td><td>3</td><td>3</td><td>2</td><td>2</td></tr>
  <tr><th>6</th><td>5</td><td>2</td><td>3</td><td>3</td><td>3</td><td>1</td><td>1</td><td>3</td></tr>
  <tr><th>7</th><td>5</td><td>4</td><td>4</td><td>2</td><td>5</td><td>5</td><td>3</td><td>5</td></tr>
</table>

### 攻撃力(ヤン補正後)

敵にヤンが参加しており、かつ味方フォーメーションが 5 でない場合、以下の補正を行う:

* `(味方攻撃力) = (味方攻撃力) / 2 + 1`
* `(敵攻撃力) += 10`

### 1 個艦隊あたりのダメージ

味方/敵とも、1 個艦隊あたりのダメージは `min(100, 100 * (相手陣営の攻撃力) / (12 * (自陣営の艦隊数)))` で算出される。

### ダメージ加算処理

味方/敵とも、通常の(駐留艦隊でない)艦隊については 1 個艦隊あたりのダメージを加算する。  
加算結果が 92 以上になる場合、その艦隊は壊滅する。

敵駐留艦隊については、その兵力から 1 個艦隊あたりのダメージを減算する。  
減算結果が 8 未満になる場合、敵駐留艦隊は壊滅する。


## 考察

各敵フォーメーションに対し、攻撃力を最大化した上で防御力を最大化する味方フォーメーションは以下の通り:

|敵フォーメーション|味方フォーメーション|味方係数|敵係数|
|--|--|--|--|
|0|0 以外|5|1|
|1|5|4|2|
|2|7|4|3|
|3|1|5|3|
|4|4, 7|5|5|
|5|7|5|2|
|6|4|5|3|
|7|3|5|2|

各敵フォーメーションに対し、防御力を最大化した上で攻撃力を最大化する味方フォーメーションは以下の通り:

|敵フォーメーション|味方フォーメーション|味方係数|敵係数|
|--|--|--|--|
|0|0 以外|5|1|
|1|5|4|2|
|2|6|3|1|
|3|1|5|3|
|4|2|4|2|
|5|7|5|2|
|6|5|2|1|
|7|3|5|2|

攻撃力の算出においては最初に攻撃可能な総兵力を 100 で割っているので、軽微なダメージが攻撃力の大幅な切り捨てに繋がりうる。  
たとえば、それぞれダメージ 1 を受けた 2 個艦隊の総兵力は 198 となるが、これは 1 個艦隊と同じ攻撃力にしかならない。

1 個艦隊同士の戦闘で、かつ両者ともフォーメーション 0 修正がない場合、  
敵フォーメーションが 1, 2 ならば最大与ダメージは 33, 敵フォーメーションがそれ以外ならば最大与ダメージは 41 となる。  
よって、1 個艦隊で敵駐留艦隊のみを相手にする場合、1 ターンで壊滅させるための条件は以下の通り:

|敵フォーメーション|敵駐留艦隊兵力|
|--|--|
|1, 2|40以下|
|それ以外|48以下|
